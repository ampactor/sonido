name: CI (Manual)

on:
  workflow_dispatch:
    inputs:
      job:
        description: 'Which job(s) to run'
        type: choice
        options:
          - all
          - bench
          - coverage
          - plugin
        default: all

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: "0"

jobs:
  bench:
    name: Benchmarks
    runs-on: ubuntu-latest
    timeout-minutes: 45
    if: inputs.job == 'bench' || inputs.job == 'all'

    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/setup-rust

      - name: Restore criterion baseline cache
        id: bench-cache
        uses: actions/cache@v4
        with:
          path: target/criterion
          key: bench-baseline-${{ github.ref_name }}-${{ github.sha }}
          restore-keys: |
            bench-baseline-${{ github.ref_name }}-
            bench-baseline-main-

      - name: Rename previous baseline for comparison
        if: steps.bench-cache.outputs.cache-hit == 'true'
        run: |
          # Rename cached "current" baselines to "prev" so critcmp can diff them
          find target/criterion -type d -name "current" -exec sh -c \
            'mv "$1" "$(dirname "$1")/prev"' _ {} \;

      - name: Ensure target dir exists for tee
        run: mkdir -p target

      - name: Run core benchmarks
        run: cargo bench -p sonido-core --benches -- --save-baseline current --output-format bencher 2>&1 | tee target/bench-core.txt

      - name: Run effects benchmarks
        run: cargo bench -p sonido-effects --benches -- --save-baseline current --output-format bencher 2>&1 | tee target/bench-effects.txt

      - name: Run synth benchmarks
        run: cargo bench -p sonido-synth --benches -- --save-baseline current --output-format bencher 2>&1 | tee target/bench-synth.txt

      - name: Run analysis benchmarks
        run: cargo bench -p sonido-analysis --benches -- --save-baseline current --output-format bencher 2>&1 | tee target/bench-analysis.txt

      - name: Install critcmp
        run: cargo install critcmp --locked

      - name: Compare with previous baseline
        if: steps.bench-cache.outputs.cache-hit == 'true'
        run: |
          critcmp prev current 2>&1 | tee target/bench-comparison.txt
          echo "::notice::Benchmark comparison report generated â€” see artifacts"

      - name: Upload benchmark artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: benchmark-results-${{ github.sha }}
          path: |
            target/bench-core.txt
            target/bench-effects.txt
            target/bench-synth.txt
            target/bench-analysis.txt
            target/bench-comparison.txt
            target/criterion/
          retention-days: 90

  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    if: inputs.job == 'coverage' || inputs.job == 'all'

    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/setup-rust
        with:
          components: llvm-tools-preview
          sccache: 'false'

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Generate coverage
        run: cargo llvm-cov --workspace --lcov --output-path lcov.info

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: lcov.info

  plugin:
    name: Plugin
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: inputs.job == 'plugin' || inputs.job == 'all'

    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/setup-rust

      - name: Run plugin tests
        run: cargo test -p sonido-plugin

      - name: Build plugin binaries
        run: cargo build --release -p sonido-plugin --examples

      - name: Verify plugin binaries exist
        run: |
          for plugin in preamp distortion compressor gate eq wah chorus flanger phaser tremolo delay filter multivibrato tape reverb limiter bitcrusher ringmod stage; do
            test -f "target/release/examples/libsonido_${plugin}.so" || { echo "Missing libsonido_${plugin}.so"; exit 1; }
          done
          echo "All 19 plugin binaries verified"

      - name: Download clap-validator
        run: |
          if [ ! -x clap-validator ]; then
            curl -L https://github.com/free-audio/clap-validator/releases/download/0.3.2/clap-validator-0.3.2-ubuntu-18.04.tar.gz -o clap-validator.tar.gz
            tar xzf clap-validator.tar.gz
            chmod +x clap-validator
          fi

      - name: Validate CLAP plugins
        run: |
          mkdir -p target/plugin-validation
          for plugin in preamp distortion compressor gate eq wah chorus flanger phaser tremolo delay filter multivibrato tape reverb limiter bitcrusher ringmod stage; do
            echo "Validating sonido_${plugin}..."
            ./clap-validator validate "target/release/examples/libsonido_${plugin}.so" 2>&1 | tee "target/plugin-validation/${plugin}.txt" || { echo "Validation failed for sonido_${plugin}"; exit 1; }
          done
          echo "All 19 CLAP plugins validated"

      - name: Upload plugin validation artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: plugin-validation-${{ github.sha }}
          path: target/plugin-validation/
          retention-days: 30
